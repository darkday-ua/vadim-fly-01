# Deploy Fly app to Hetzner VM on push to main.
# Builds Docker image (versioned by git SHA), pushes to Docker Hub, then SSHs
# to the server and runs docker compose pull / up -d and migrations.

name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE: darkday443/vadim-fly

jobs:
  build-and-push:
    name: Build and push image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract short SHA
        id: sha
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE }}:${{ steps.sha.outputs.short_sha }}
            ${{ env.IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to server
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set short SHA
        id: sha
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set up SSH key
        run: |
          install -m 700 -d ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy on server
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/opt/fly' }}
        run: |
          IMAGE_TAG="${{ steps.sha.outputs.short_sha }}"
          APP_IMAGE="${{ env.IMAGE }}:${IMAGE_TAG}"
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${DEPLOY_PATH} && \
             (git pull --rebase 2>/dev/null || true) && \
             export APP_IMAGE=${APP_IMAGE} && \
             docker compose pull && \
             docker compose up -d && \
             docker compose exec -T app php scripts/migrate.php || true"
