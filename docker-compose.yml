# Base stack: app, MySQL, nginx (80 + 443), certbot for Let's Encrypt.
# Set DOMAIN and CERTBOT_EMAIL in .env for HTTPS. First run: see docs for certbot certonly.

services:
  app:
    image: ${APP_IMAGE:-darkday443/vadim-fly:latest}
    build: .
    environment:
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=${DB_NAME:-fly}
      - DB_USER=${DB_USER:-root}
      - DB_PASSWORD=${DB_PASSWORD}
      - DEFAULT_USERNAME=${DEFAULT_USERNAME:-admin}
      - DEFAULT_PASSWORD=${DEFAULT_PASSWORD}
    depends_on:
      mysql:
        condition: service_healthy

  mysql:
    image: mysql:8
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-${DB_PASSWORD}}
      MYSQL_DATABASE: ${DB_NAME:-fly}
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 10

  nginx:
    image: nginx:alpine
    volumes:
      - ./docker/nginx.conf.template:/etc/nginx/templates/nginx.conf.template:ro
      - ./docker/nginx-entrypoint.sh:/entrypoint.sh:ro
      - certbot_webroot:/var/www/certbot:ro
      - letsencrypt:/etc/letsencrypt
    ports:
      - "${APP_PORT:-80}:80"
      - "443:443"
    environment:
      DOMAIN: ${DOMAIN:-localhost}
    entrypoint: ["/bin/sh", "/entrypoint.sh"]
    depends_on:
      - app

  certbot:
    image: certbot/certbot
    volumes:
      - letsencrypt:/etc/letsencrypt
      - certbot_webroot:/var/www/certbot
    environment:
      - DOMAIN=${DOMAIN}
      - CERTBOT_EMAIL=${CERTBOT_EMAIL}
    # Not started by default. First cert: docker compose run --rm certbot certonly --webroot -w /var/www/certbot -d $DOMAIN -m $CERTBOT_EMAIL --agree-tos --non-interactive
    # Renew: docker compose run --rm certbot renew && docker compose exec nginx nginx -s reload
    profiles:
      - certbot

volumes:
  mysql_data:
  certbot_webroot:
  letsencrypt:
